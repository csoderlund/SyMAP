<HTML>
<HEAD>
	<TITLE>SyMAP Troubleshooting</TITLE>
	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
	<style>
		a.wt {color:inherit;}
		table {font-size:100%}
		tr {font-size:100%}
		td {font-size:100%}
		tt {font-size:13px}
		a {font-size:100%}
		li {padding-top:2px;}
	</style>
</head>
<body style="font-family:Verdana, Arial, Helvetica, sans-serif;font-size:100%">
<!--#include virtual="/common/uaheader.html" -->

	<a name=top></a>
	<table align="center" width=750 style="border: 1px solid #999999" cellspacing="0" cellpadding="0">
	  <tr>
	  <td>
		  <table width="750" border="0" align="center" cellpadding="0" cellspacing="0">
		    <tr>
    	  <td height="60" width="161" align="left" valign="bottom">
       		<img alt="" title="" src="img/agcol_logo.png">
       	</td>
		    <td height="60" width="428" align="left" valign="bottom"
				style="padding:0px 0px 10px 30px">
			    <font face="Verdana, Arial, Helvetica, sans-serif" color="#000066" size="5">
				    <b>SyMAP Troubleshooting</b>
			    </font> 
		    </td>
		    <td height="60" width="161" align="center" valign="bottom">&nbsp;
        </td>
		    </tr>

		    <tr>
		    <td height="21" colspan="3" align="left">
			    <table width="100%" border="0" cellspacing="0" cellpadding="3" height="18">
			    <tr>
			    <td align="left" bgcolor="#666666">
<span style="font-size:75%;color:white">
<a href="http://www.agcol.arizona.edu" class="wt">AGCoL</a> |
<a href=../index.html class="wt">SyMAP Home</a> |
<a href=SystemGuide.html class="wt">System Guide</a> |
<a href=UserGuide.html class="wt">User Guide</a> |
<a href=Tour.html class="wt">Tour</a> |
Troubleshooting 
</span>
          </table>
			    </td>
			    </tr>
          <tr>
    	    <td colspan="3" valign="top" align="left" style='padding:15px;font-size:85%;width:750px;'>

<a name="top"></a>
<br>
<i>Please send questions and suggestions to symap@agcol.arizona.edu.</i><br>
<p>
<ul>
<li>General
<ul>
<li><a href="#not_enough_memory1">Not enough memory with standalone</a></li>
</ul>

<li>MySQL
<ul>
<li><a href="#database_error">Database connect errors</a> ("Unable to connect","Error running SQL Command",...)</li>
<li><a href="#mariadb">MariaDB cannot connect</a>
<li><a href="#msqslow">Slow to load sequence and annotation</a>
<li><a href="#slow">Slow queries</a>
</ul>

<li>Build problems
<ul>
<li>Database
<ul>
<li><a href="#innodb">The MySQL database does not support Innodb tables</a>
<li><a href="#mysql_norun">The built-in MySQL server cannot run...</a></li>
<li><a href="#root">Please read "Security" section of the manual to find out how to run mysqld as root</a> 
<li><a href="#msqcase"> Can't create table  (errno: 121)</a>
</ul>

<li>Alignment
<ul>
<li><a href="#status">Status window disappeared</a>
<li><a href="#glib">/lib64/libc.so.6: version `GLIBC_2.7' not found </a>
<li><a href="#mumFail">MUMmer failed</a></li>
<li><a href="#mum64">MUMmer/PROmer can't handle large sequences</a>	
<li><a href="#noanch">No anchors loaded</a>
<li><a href="#bes">BES not loaded</a>
</ul>
</ul>

<li>Web problems
<ul>
<li><a href="#web">Unable to view Java applets</a>
<li><a href="#not_enough_memory2">Not enough memory on web</a></li>
</ul>

</ul>

<hr>
<h2>General</h2>
<a name="#not_enough_memory1">
<h3>Not enough memory with standalone</h3>
When running SyMAP as a standalone application:
For very large projects, or queries involving multiple
genomes (e.g., 5 or more), the Project Manager may run out of memory.
To fix this problem, run symap with the -m parameter to increase the maximum
memory used from the default 2048 MB to 4096 MB.:
<pre><b>     &#62 ./symap -m 4096</b></pre>
Alternatively, you can edit the file <tt>symap</tt> and change
<pre>
my $maxmem="2048m"; # change this line to use "4096m" 
</pre>

You will also need to be using a 64-bit processor. 

<p><a href="#top">Return to top</a><br>

<!---------------------------------------------------------!>
<hr>
<h2>MySQL</h2>
<a name="database_error">
<h3>Database connect errors</h3>
Error messages mentioning the database or SQL probably mean that the database connection
could not be established or was lost. A message at startup means SyMAP was not able
to connect to the database using the provided information in <tt>symap.config</tt>; see below for 
steps to debug this. 
<p>
After startup, if the program is left idle for some time then its
database connection will close and it will show a complicated-looking error on 
next usage. In this case the solution is to restart the program.
<p>

Following are some things to check for connection problems on SyMAP startup:

<p><u>Check the database privileges</u>:
The database users specified in symap.config may not have necessary access to the database.
If you are running the standalone version, then the relevant user is 'db_adminuser' (unless
you are running a read-only session using <tt>viewSymap</tt>). If you are running
through the web applet, then is is 'db_clientuser'. In either case the user needs
to have database access privileges <i>from the machine where you are working</i>. 
Note that MySQL
privileges are granted specifically to certain users on certain machines. You can test 
the user access by using the MySQL command line client <tt>mysql</tt>, if it is installed
on your machine, or by looking at the privilege table using an administration interface
such as PHPMyAdmin. The <tt>mysqlaccess</tt> tool is also useful, if it is installed
on your machine. 

<p><u>Check the MySQL configuration</u>:
The MySQL configuration file (/etc/my.cnf) should <b>not</b> contain any
of the following lines that prevent remote access to the database.
<tt><pre>     bind_address=127.0.0.1
     skip_networking 
</pre></tt>

<p><u>Make sure the port is visible</u>:
If the database is on a different computer, test that its port 3306 is visible
from your computer:
<pre>     telnet &lt;server address&gt; 3306
</pre>

If it doesn't make a connection then either the server isn't running, or 
it is set to run on a non-standard port, or the
port is blocked by a firewall. Contact a system administrator. (Note, 
to get out of telnet type "<tt>^]</tt>".)

<a name="mariadb">
<h4>MariaDB cannot connect </h4>
If you are using MariaDB (post version 10.4.12) and get the error:
<pre>
Unable to connect to the mysql database on localhost; are username and password correct?
</pre>
Try adding the following lines to the <tt>/etc/my.cnf</tt>:
<pre>
[mysqld]
character-set-server=utf8mb4
</pre>
And restart MariaDB with <tt>systemctl restart mariadb</tt>. 
<p>Thanks to Lori for this solution! 

<a name="msqslow">
<h3>Slow to load sequence and annotation</h3>

Two MySQL settings are especially important for SyMAP performance (and generally for InnoDB table
performance). You can set these in the MySQL configuration file "my.cnf" and restart MySQL. 
Note that my.cnf is located at /etc/my.cnf, on both Linux and Mac.
<p>
<table width=600 cellspacing=3 cellpadding=2 border=1 rules=all>
	<tr>
		<td align=left valign=top><tt>innodb_buffer_pool_size</td>
		<td>
The default is too low for most purposes. You should set this to around 1Gb if possible (note that 
the units are bytes). 
		</td>
	</tr>
	<tr>
		<td align=left valign=top><tt>innodb_flush_log_at_trx_commit=0</td>
		<td>
The default setting is 1, which results in very slow uploading of data.
		</td>
	</tr>
</table>
<p>
To check the values, start mysql and type:
<pre>
show variables like "innodb_buffer_pool_size"; 
show variables like "innodb_flush_log_at_trx_commit"; 
</pre>
To change the variables, then type:
<pre>
set global innodb_buffer_pool_size=1073741824;
set global innodb_flush_log_at_trx_commit=0;
</pre>
Different machines and MySQL installations can produce different results with these variables.
If the SyMAP demo-seq to demo-seq2 load and synteny computations seem slow, 
try different combinations of these two variables to see what performs the fastest inserts.


<a name="slow">
<h3>Slow queries</h3>
<table width=600 cellspacing=3 cellpadding=2 border=1 rules=all>
	<tr>
		<td align=left valign=top><tt>max_allowed_packet</td>
		<td>
This should be at least 500M if possible (the units are bytes). 
		</td>
	</tr>	
</table>
<p>
To check the value, start mysql and type:
<pre>show variables like "max_allowed_packet"; </pre>
To change this variable, then type:
<pre>set global max_allowed_packet=1073741824;</pre>
<p><a href="#top">Return to top</a><br>

<!--------------------------------------------------------!>
<hr>
<h2>Build problems</h2>

<h3>Database</h3>
Note that the demo_seq should load
in less than a minutes, if its longer, check the variables stated in <a href=#msqslow>slow to load</a>.

<a name="innodb">
<h5>The database does not support Innodb tables</h5>
This can happen in a couple of ways ways. Look in the mysql log for clues.  
<li> MySQL started with the "skip-innodb" flag. Solution is to remove this. 
<li> InnoDB log file problems. This can happen if you change the log file size, without
deleting the log file. Solution: shut down mysql, remove the innodb log file, and restart mysql. 

<a name="mysql_norun">
<h5>"The built-in MySQL server cannot run..."</h5>
SyMAP comes with a MySQL server built in, but it does not run right if there is another
MySQL server already running on the computer. There are two solutions: either stop the 
other server temporarily, or edit the parameters file to point SyMAP at that server (or
another server) so it doesn't use the built-in MySQL. 

<a name="root">
<h5>Please read "Security" section of the manual to find out how to run mysqld as root</h5> 
You are launching SyMAP as the unix root user, which is blocked by MySQL 
as a security hazard. Solution is simply to use a regular non-root user account.  

<a name="msqcase">
<h5>Can't create table  (errno: 121)</h5>
This can occur if you try to create a SyMAP database whose name differs only by
case from an existing database, e.g. "symapTest" when "symaptest" already exists. 

<p><a href="#top">Return to top</a><br>

<h3>Alignment</h3>

<a name="status">
<h4>Status window disappeared</h4>
Occasionally the status window disappears when running an alignment. 
Clicking the top of the project manager sometimes
brings it back. Otherwise, just check the output to the terminal,
which tells you when it is done. You may
have to restart the project manager to see the results.

<a name="glib">
<h4>/lib64/libc.so.6: version `GLIBC_2.7' not found </h4>
If this occurs while you are doing an alignment, it
 means that some libraries on your system are not compatible with those
required by the version of MUMmer which is included with SyMAP. To solve this
you will need to obtain the MUMmer source code distribution and compile
it on your own system, which is not hard to do (however, 
<a href="#mum64">note this important detail</a>). Then, copy the binary named
"mummer" to the appropriate ext/mummer/&lt;platform&gt; directory and re-run SyMAP. 

<a name="mumFail">
<h4>MUMmer failed</h4>
Try using a hard-masked genome sequence. Ensembl supplies both soft-masked and
hard-masked genome sequences. NCBI supplies soft-masked sequences, where the
supplied ConvertNCBI script (scripts/ConvertNCBI) can convert the file to hard-mask.

<a name="mum64">
<h4>MUMmer/PROmer cannot handle large sequences</h4>
If the alignment doesn't produce results and you see errors indicating
that PROmer cannot produce the .aaqry file, then the mummer binary may
not be 64-bit. You can tell for sure by looking at the output lines like
<pre>
# (maximum reference length is 536870908)
# (maximum query length is 4294967295)
</pre>
If you see small numbers like this, it is not 64-bit. For 64-bit, the numbers
are extremely large, much larger than any possible genome.
To build a 64-bit mummer, you must set  
<pre>
#define SIXTYFOURBITS 
</pre>
in 
src/kurtz/libbasedir/types.h (and, of course,
compile on a 64-bit machine). We fixed this problem in the 3.4 version of SyMAP, 
for lintel64, but if you're building for a different platform you'll have
to make this fix. 

<a name="noanch">
<h4>No anchors loaded</h4>
This message indicates that SyMAP could not parse the MUMmer or BLAT output files
to load the anchors. 
<p>
The most likely reason is that MUMmer or BLAT failed to run.
Usually this is because the platform (linux 32/64 bit, or mac)
was not detected properly. First try re-starting symap using
the '-32, -64, -linux, -mac' parameters to specify your platform 
(run 'symap -h' for list of parameters). 
<p>
The next likely cause is trying to run a whole-chromosome MUMmer alignment on a 32-bit
machine. MUMmer usually uses more than 2Gb per thread, which is not
possible on a 32-bit machine. If you suspect this is the problem, try running
on a 64-bit machine. If you compiled MUMmer yourself, check 
<a href="#mum64">the above section</a>.
<p>
If that does not resolve the problem, The next step is to look in the project
.log file in the /logs directory for 
more detailed error messages. Then, you should look at the MUMmer log
files (extension .mum.log) in the directory
<tt>
<pre>
logs/&lt;proj1_to_proj2&gt;
</pre>
</tt>
These contain the messages printed by MUMmer, and should show why it failed to run.  
<p>

<a name="bes">
<h4>BES not loaded, or BES hits not loading</h4>
Generally, this is caused by a name formatting error. Make sure the BES
names are formatted as clone names with extension "r" or "f". The clone
names should <i>exactly match</i> those in FPC, and there should be no other prefix or suffix. 
Do not use ".r" or ".f". 

<p><a href="#top">Return to top</a><br>
<hr>
<!--------------------------------------------------------!>
<h2>Web problems</h2>
<a name="web">
<h4>Unable to view Java applets</h4>

<ul>
<li>SyMAP requires the Java Runtime Environment (JRE) version 7 or later. The latest version tested is Java 8 Update 221.
<li>Java Applets ONLY work with Windows Internet Explorer and Mac Safari.
<li>A popup will first appear asking you to confirm that you trust this website.
<li>It is useful to have the Java Console enabled so you can view the SyMAP trace output. 
 </ul>
 
<a name="not_enough_memory2">
<h4>Not enough memory on web</a></h4>
This section may be out-of-date.
<p>When running SyMAP from a web page (i.e., as an applet):
The default Java applet memory limit is very low, and memory may run out
for large displays or for the 2D Base View.  Increase the Java memory limit for your system using 
the instructions below:
<p>
On Windows:
<ol>
<li>From the <b>Start</b> menu button, select <b>Settings</b>, then <b>Control Panel</b> to open the Control Panel.
Or right click on the Java icon in the lower right of the task bar.
<li>Double click the Java icon to open the <b>Java Control Panel</b>.
<li>Select the <b>Java</b> tab.
<li>Click the <b>View</b> button under <b>Java Applet Runtime Settings</b>.
<li>For each row, click the <b>Java Runtime Parameters</b> column and type <b>-Xmx512m</b> and press enter.
<li>Click the <b>OK</b> button to close the Control Panel.
<li>Restart your browser.
</ol>
On Mac:
<ol>
<li>In the Finder, select <b>Go</b> then select <b>Applications</b>.
<li>In the new window select <b>Utilities</b>, then double-click <b>Java Preferences</b> to open the <b>Java Control Panel</b>.
<li>Select the top-most Java version in the list under <b>Java Applet Plugin</b> and click <b>Options</b>.
<li>Under <b>Java Runtime Parameters</b> enter <b>-Xmx512m</b>.
<li>Click the <b>OK</b> button and close the Control Panel.
<li>Restart your browser.
</ol>
On Unix:
<ol>
<li>First locate the Java plugin file, under your home directory in either 
	<tt>~/.mozilla/plugins</tt> or <tt>~/.mozilla/firefox/plugins</tt>
<li>Use <tt>ls -l</tt> to find where the plugin is linked from. This is the Java install directory. 
<li>Change to the install directory and execute <b>bin/ControlPanel</b> to open the <b>Java Control Panel</b>.
<li>Select the <b>Java</b> tab.
<li>Click the <b>View</b> button under <b>Java Applet Runtime Settings</b>.
<li>For each row, click the <b>Java Runtime Parameters</b> column and enter <b>-Xmx512m</b>.
<li>Click the <b>OK</b> button to close the Control Panel.
<li>Restart your browser.
</ol>
<p><a href="#top">Return to top</a><br>
<hr>


</div>
</table>
  <table width="100%" border="0" align="center">
    <tr>
      <td bgcolor="#DDDDDD" align="center">
       <font face="Verdana, Arial, Helvetica, sans-serif" size="2">Email
       Comments To: <a href="mailto:symap@agcol.arizona.edu">symap@agcol.arizona.edu</a></font></td>

    </tr>
  </table>
<br>

<p>&nbsp;</p>
		</td>
	</tr>

</table>
</BODY>
</HTML>








